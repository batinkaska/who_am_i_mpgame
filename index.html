<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Who Am I?</title>
    <link rel="icon" href="https://fav.farm/â“" />
    <style>
        /* --- GENERAL STYLES --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #1e1e2e; 
            color: #fff; 
            text-align: center; 
            margin: 0; 
            padding: 10px; 
            padding-bottom: 70px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            box-sizing: border-box;
        }
        
        .screen { display: none; width: 100%; max-width: 600px; animation: fadeIn 0.4s; }
        .active { display: block; }
        
        h1, h2, h3 { color: #f1c40f; margin: 10px 0; }
        .box { background: #2b2b40; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); position: relative; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #161622; color: white; font-size: 16px; box-sizing: border-box; }
        
        button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-green { background: #27ae60; }
        .btn-blue { background: #2980b9; }
        .btn-red { background: #c0392b; }
        .btn-yellow { background: #f39c12; color: #222; }
        .btn-guess { background: #8e44ad; color: white; } 
        .btn-purple { background: #8e44ad; color: white; }

        /* HEADER CONTROLS */
        .game-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 600px; margin-bottom: 10px; position: relative; z-index: 100; }
        .control-btn { background: #333; color: #fff; border: 1px solid #555; padding: 8px 12px; font-size: 0.9em; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; width: auto; margin: 0; }
        .control-btn:hover { background: #444; }
        .right-controls { display: flex; gap: 10px; align-items: center; }

        /* MENU BUTTONS */
        .menu-btn {
            background-color: #2b2b40;
            color: #fff;
            padding: 20px;
            margin: 10px 0;
            border-radius: 15px;
            border: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            font-size: 1.1em;
            text-align: left;
            transition: transform 0.2s, background 0.2s;
        }
        .menu-btn:hover {
            transform: scale(1.02);
            background-color: #35354a;
            border-color: #f1c40f;
        }
        .menu-icon {
            font-size: 1.5em;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* BACK BUTTON */
        .btn-back { background: transparent; color: #aaa; border: none; text-align: left; padding: 0; margin-bottom: 10px; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        .btn-back:hover { color: #fff; }

        /* DROPDOWN MENU */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 110%; background-color: #2b2b40; min-width: 140px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); border-radius: 8px; border: 1px solid #444; overflow: hidden; z-index: 999; }
        .dropdown-content div { color: white; padding: 12px 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; cursor: pointer; text-align: left; font-size: 0.9em; }
        .dropdown-content div:hover { background-color: #35354a; }
        .show { display: block; animation: fadeIn 0.2s; }

        /* INTRO TEXT */
        .game-intro { font-size: 0.95em; color: #ccc; line-height: 1.6; margin-bottom: 20px; text-align: left; }

        /* GAME LAYOUT */
        .vote-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        ul { list-style: none; padding: 0; }
        li { background: #35354a; padding: 10px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .lives-display { font-size: 1.5em; margin: 10px 0; letter-spacing: 5px; }
        
        .eliminated-banner { background: #c0392b; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; animation: fadeIn 0.5s; }
        .success-banner { background: #27ae60; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; animation: fadeIn 0.5s; border: 2px solid #2ecc71; }

        /* CHARACTERS LIST */
        .char-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .char-card { background: #1f1f2e; padding: 10px; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; position: relative; }
        .char-card.is-me { border: 2px solid #f1c40f; background: #2d2d3f; } 
        .char-card-name { font-size: 0.8em; color: #aaa; margin-bottom: 5px; }
        .char-card-val { font-size: 1.1em; font-weight: bold; color: #fff; }
        .char-card-val.hidden { color: #f1c40f; letter-spacing: 2px; font-size: 1.4em; }
        
        .status-badge { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 12px; }
        .status-won { background: #27ae60; color: white; content: 'âœ“'; }
        .status-dead { background: #c0392b; color: white; content: 'X'; }

        /* SETUP LIST STYLES */
        .setup-list-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .setup-player-badge { background: #35354a; padding: 6px 12px; border-radius: 20px; font-size: 0.9em; display: flex; align-items: center; gap: 6px; border: 1px solid #444; }
        .setup-player-badge.done { border-color: #27ae60; background: rgba(39, 174, 96, 0.2); }

        /* HISTORY BOARD */
        .history-board { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; align-items: flex-start; }
        .player-column { min-width: 140px; max-width: 140px; background: #232330; border-radius: 8px; padding: 5px; border: 1px solid #444; flex-shrink: 0; }
        .player-col-header { font-weight: bold; color: #f1c40f; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .result-group { margin-bottom: 8px; }
        .res-title { font-size: 0.7em; text-transform: uppercase; color: #888; margin-bottom: 2px; text-align: left; padding-left: 2px; }
        .q-item { font-size: 0.75em; padding: 3px 5px; margin-bottom: 2px; border-radius: 4px; text-align: left; color: #fff; }
        .group-yes .q-item { background: rgba(39, 174, 96, 0.3); border-left: 3px solid #27ae60; }
        .group-no .q-item { background: rgba(192, 57, 43, 0.3); border-left: 3px solid #c0392b; }
        .group-unsure .q-item { background: rgba(243, 156, 18, 0.2); border-left: 3px solid #f39c12; }
        .guess-item { border: 1px dashed #f1c40f !important; font-weight: bold; }

        /* LEADERBOARD */
        .lb-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #444; align-items: center; }
        .lb-rank { font-size: 1.5em; font-weight: bold; width: 40px; }
        .lb-info { text-align: left; flex-grow: 1; margin-left: 10px; }
        .lb-name { font-size: 1.1em; color: #fff; }
        .lb-char { font-size: 0.9em; color: #f1c40f; }
        .lb-medal-1 { color: #f1c40f; }
        .lb-medal-2 { color: #bdc3c7; }
        .lb-medal-3 { color: #cd7f32; }

        /* FOOTER */
        .app-footer { position: fixed; bottom: 0; left: 0; width: 100%; padding: 10px 0; background-color: #1e1e2e; color: #555; font-size: 0.75em; text-align: center; z-index: 50; border-top: 1px solid #333; }

        /* MATCHMAKING COUNTER */
        .mm-counter { color: #2ecc71; font-size: 0.9em; margin-top: 5px; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="main-header" class="game-controls" style="display:none;">
        <button id="btn-leave" class="control-btn" onclick="leaveRoom()">ğŸšª Leave</button>
        <div class="right-controls">
            <button id="reset-btn" class="control-btn" style="display:none; color:#f39c12; border-color:#f39c12;" onclick="resetGame()">ğŸ”„ Reset</button>
            <div class="dropdown">
                <button onclick="toggleLang()" class="control-btn" id="lang-btn-display">ğŸ‡ºğŸ‡¸ English â–¾</button>
                <div id="langDropdown" class="dropdown-content">
                    <div onclick="setLanguage('en')">ğŸ‡ºğŸ‡¸ English</div>
                    <div onclick="setLanguage('tr')">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</div>
                    <div onclick="setLanguage('de')">ğŸ‡©ğŸ‡ª Deutsch</div>
                    <div onclick="setLanguage('es')">ğŸ‡ªğŸ‡¸ EspaÃ±ol</div>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <h1 style="font-size: 2.5em; letter-spacing: 2px;">WHO AM I?</h1>
        <p id="lbl-subtitle" style="color: #aaa; margin-top: -10px;">Test Your Knowledge!</p>
    </div>

    <div id="screen-welcome" class="screen active">
        <div style="width: 100%; max-width: 400px; margin: 0 auto;">
            
            <button class="menu-btn" onclick="goToLogin(false)">
                <div class="menu-icon">ğŸ‘¥</div>
                <div style="display:flex; flex-direction:column;">
                    <span id="btn-menu-play" style="font-weight:bold;">Play with Friends</span>
                    <span id="btn-menu-play-sub" style="font-size:0.8em; color:#aaa;">Create or Join a Private Room</span>
                </div>
            </button>

            <button class="menu-btn" onclick="goToLogin(true)">
                <div class="menu-icon">ğŸŒ</div>
                <div style="display:flex; flex-direction:column;">
                    <span id="btn-menu-find" style="font-weight:bold;">Find Game</span>
                    <span id="btn-menu-find-sub" style="font-size:0.8em; color:#aaa;">Match with Random Players</span>
                </div>
            </button>

            <button class="menu-btn" onclick="showHowToPlay()">
                <div class="menu-icon">â“</div>
                <div style="display:flex; flex-direction:column;">
                    <span id="btn-menu-rules" style="font-weight:bold;">How to Play</span>
                    <span style="font-size:0.8em; color:#aaa;">Game Rules</span>
                </div>
            </button>

            <button class="menu-btn" onclick="showLanguages()">
                <div class="menu-icon">ğŸŒ</div>
                <div style="display:flex; flex-direction:column;">
                    <span id="btn-menu-lang" style="font-weight:bold;">Language</span>
                    <span id="btn-menu-lang-sub" style="font-size:0.8em; color:#aaa;">Change App Language</span>
                </div>
            </button>

        </div>
    </div>

    <div id="screen-login" class="screen">
        <div class="box">
            <button class="btn-back" onclick="goBackToWelcome()">â€¹ Back</button>
            <h3 id="lbl-enter-details">Enter Details</h3>
            <input type="text" id="username" placeholder="Enter your name">
            
            <div id="private-controls">
                <button id="btn-create" class="btn-green" onclick="createRoom()">Create New Room</button>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <input type="text" id="room-code-input" placeholder="Room Code" style="margin:0; text-transform:uppercase;">
                    <button id="btn-join" class="btn-blue" onclick="joinRoom()" style="margin:0; width: 40%;">Join</button>
                </div>
            </div>

            <div id="public-controls" style="display:none;">
                <button class="btn-purple" onclick="goToMatchmakingSetup()">Next: Matchmaking â”</button>
            </div>

        </div>
    </div>

    <div id="screen-matchmaking" class="screen">
        <div class="box">
            <button class="btn-back" onclick="goToLogin(true)">â€¹ Back</button>
            <h3 id="lbl-mm-title">Matchmaking</h3>
            
            <label id="lbl-mm-lang" style="font-size:0.9em; color:#aaa; display:block; text-align:left;">Language Preference</label>
            <select id="mm-lang" onchange="updateOnlineCount()">
                <option value="en">ğŸ‡ºğŸ‡¸ English (Global)</option>
                <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
                <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
            </select>

            <label id="lbl-mm-size" style="font-size:0.9em; color:#aaa; display:block; text-align:left; margin-top:10px;">Players Count</label>
            <select id="mm-size" onchange="updateOnlineCount()">
                <option value="2" selected>2 Players</option>
                <option value="3">3 Players</option>
                <option value="4">4 Players</option>
            </select>

            <div id="mm-online-count" class="mm-counter">Online: ...</div>

            <button id="btn-mm-search" class="btn-green" style="margin-top:20px;" onclick="findPublicGame()">ğŸ” Search Game</button>
            <p id="mm-status" style="display:none; color:#f1c40f; margin-top:10px;">Searching for rooms...</p>
        </div>
    </div>

    <div id="screen-howtoplay" class="screen">
        <div class="box">
            <button class="btn-back" onclick="goBackToWelcome()">â€¹ Back</button>
            <h3 id="lbl-rules-title" style="border-bottom:1px solid #444; padding-bottom:10px;">How to Play</h3>
            <div id="lbl-rules-text" class="game-intro"></div>
        </div>
    </div>

    <div id="screen-languages" class="screen">
        <div class="box">
            <button class="btn-back" onclick="goBackToWelcome()">â€¹ Back</button>
            <h3>Select Language</h3>
            <button class="menu-btn" onclick="setLanguage('en'); goBackToWelcome()">ğŸ‡ºğŸ‡¸ English</button>
            <button class="menu-btn" onclick="setLanguage('tr'); goBackToWelcome()">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</button>
            <button class="menu-btn" onclick="setLanguage('de'); goBackToWelcome()">ğŸ‡©ğŸ‡ª Deutsch</button>
            <button class="menu-btn" onclick="setLanguage('es'); goBackToWelcome()">ğŸ‡ªğŸ‡¸ EspaÃ±ol</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="box">
            <p id="lbl-room-code">Room Code:</p>
            <h1 id="lobby-code" style="letter-spacing: 5px; font-size: 40px; color: #fff;">----</h1>
            <p id="lbl-waiting-players">Waiting for players...</p>
            <ul id="player-list"></ul>
            
            <div id="admin-panel" style="display:none; border-top: 1px solid #444; padding-top: 10px;">
                <p id="lbl-you-admin" style="color: yellow; font-size: 0.9em;">You are the Admin</p>
                <button id="btn-start" class="btn-green" onclick="startSetup()">Start Game</button>
            </div>
            
            <p id="public-wait-msg" style="display:none; color:#2ecc71;">Matchmaking... Game will start automatically when full.</p>
            <p id="waiting-msg" style="display:none; color:#aaa;">Waiting for admin to start...</p>
        </div>
    </div>

    <div id="screen-setup" class="screen">
        <div class="box">
            <h3 id="lbl-assign-title">Assign Character</h3>
            <p id="lbl-assign-desc">Assign a character for:</p>
            <h2 id="target-player-name" style="color:#f1c40f">...</h2>
            <input type="text" id="character-input" placeholder="E.g. Elvis, Batman...">
            <button id="btn-submit-char" class="btn-blue" onclick="submitCharacter()">Submit</button>
            <p id="setup-status" style="color: #aaa; margin-top: 10px;">Waiting for others...</p>
        </div>
        <div class="box" style="background: #232330;">
            <p id="lbl-room-players" style="font-size: 0.9em; color: #888; margin-top:0;">Players in Room</p>
            <div id="setup-player-list" class="setup-list-container"></div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="success-msg" class="success-banner" style="display:none;">
            <h3 id="lbl-congrats">ğŸ‰ CORRECT!</h3>
            <p><span id="lbl-char-was">Your character was:</span> <strong id="reveal-char-win" style="font-size:1.2em;"></strong></p>
            <small id="lbl-wait-end">Waiting for others to finish...</small>
        </div>
        <div id="eliminated-msg" class="eliminated-banner" style="display:none;">
            <h3 id="lbl-eliminated">ğŸ’€ YOU ARE OUT!</h3>
            <p><span id="lbl-was">Your character was:</span> <strong id="reveal-char" style="color:#f1c40f; font-size:1.2em;"></strong></p>
            <small id="lbl-jury-mode">You can still vote as a Jury!</small>
        </div>
        <div class="box">
            <p id="lbl-players-chars" style="margin:0; font-size: 0.9em; color:#888;">PLAYERS & CHARACTERS</p>
            <div id="characters-list" class="char-grid"></div>
        </div>
        <div class="lives-display" id="my-lives">â¤ï¸â¤ï¸â¤ï¸</div>
        <div class="box">
            <p id="lbl-whose-turn">Whose Turn?</p>
            <h2 id="current-turn-name" style="color: #27ae60;">...</h2>
        </div>
        <div id="my-turn-area" style="display: none;">
            <div class="box">
                <input type="text" id="question-input" placeholder="Ask a question...">
                <button id="btn-send-q" class="btn-blue" onclick="askQuestion()">Send Question</button>
                <hr style="border-color:#444">
                <input type="text" id="guess-input" placeholder="Make a guess...">
                <button id="btn-send-guess" class="btn-guess" onclick="makeGuess()">GUESS (Risk a Life)</button>
            </div>
        </div>
        <div id="voting-area" style="display: none;">
            <div id="waiting-vote-msg" style="display:none; padding:20px; color:#f1c40f; animation:fadeIn 0.5s;"></div>
            <div class="box">
                <p id="vote-title">Current Question:</p>
                <h3 id="voting-question" style="color: #fff;">...</h3>
                <div class="vote-grid">
                    <button id="btn-yes" class="btn-green" onclick="vote('yes')">YES</button>
                    <button id="btn-no" class="btn-red" onclick="vote('no')">NO</button>
                    <button id="btn-unsure" class="btn-yellow" onclick="vote('unsure')">UNSURE</button>
                </div>
            </div>
        </div>
        <div class="box" style="text-align: left; background: #1a1a25;">
            <h4 id="lbl-history" style="border-bottom: 1px solid #444; padding-bottom:5px;">Game History</h4>
            <div id="history-board" class="history-board"></div>
        </div>
    </div>

    <div id="screen-leaderboard" class="screen">
        <div class="box">
            <h2 id="lbl-game-over-title">ğŸ† GAME OVER!</h2>
            <div id="leaderboard-list"></div>
            <button class="btn-green" onclick="resetGame()" style="margin-top:20px;">ğŸ”„ New Game</button>
        </div>
    </div>

    <div class="app-footer">
        2026 Who Am I Game. All rights reserved.<br>
        Designed & Developed by Batin Kaska
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove, push, query, orderByChild, equalTo, onDisconnect } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: import.meta.env.VITE_FIREBASE_API_KEY, 
            authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
            databaseURL: import.meta.env.VITE_FIREBASE_DATABASE_URL,
            projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
            storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
            messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
            appId: import.meta.env.VITE_FIREBASE_APP_ID,
            measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID
        };

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase connected.");
        } catch (e) {
            alert("Firebase Error: " + e.message);
        }

        // --- TRANSLATION DICTIONARY ---
        const translations = {
            en: {
                flag: "ğŸ‡ºğŸ‡¸", langName: "English",
                btn_menu_play: "Play with Friends", btn_menu_play_sub: "Create or Join a Private Room",
                btn_menu_find: "Find Game", btn_menu_find_sub: "Match with Random Players",
                btn_menu_rules: "How to Play", btn_menu_lang: "Language", btn_menu_lang_sub: "Change Language",
                lbl_rules_title: "How to Play",
                lbl_enter_details: "Enter Details", btn_back: "â€¹ Back",
                lbl_rules_text: "1. <b>Assign Character:</b> At the start, you'll be given a friend's name. Write a challenging and fun <b>famous character</b> (Singer, Athlete, Movie Character, etc.) for them.<br><br>2. <b>Ask Questions:</b> When it's your turn, ask the group Yes/No questions to find out who you are (e.g. 'Am I real?', 'Am I a singer?', 'Am I male?'). Your friends will vote <b>Yes</b>, <b>No</b>, or <b>Unsure</b>.<br><br>3. <b>Voting Result:</b> The majority vote determines the answer.<br><br>4. <b>Guess & Lives:</b> If you know who you are, use the <b>'Guess'</b> button. Be careful! A wrong guess costs <b>1 Life (â¤ï¸)</b>.<br><br>5. <b>Jury Mode:</b> If you lose all 3 lives, you are out. But don't worry! You stay as a 'Jury' and continue voting on others' questions.<br><br>6. <b>Winning:</b> Players who guess correctly are ranked on the leaderboard by speed!",
                
                ph_name: "Enter your name", btn_create: "Create New Room", ph_room: "Room Code", btn_join: "Join",
                lbl_room: "Room Code:", lbl_wait: "Waiting for players...", lbl_admin: "You are the Admin", btn_start: "Start Game",
                lbl_wait_admin: "Waiting for admin to start...", lbl_assign_t: "Assign Character", lbl_assign_d: "Assign a character for:",
                ph_char: "E.g. Elvis, Batman...", btn_submit: "Submit", msg_wait_others: "Waiting for others...",
                btn_leave: "ğŸšª Leave", btn_reset: "ğŸ”„ Reset",
                lbl_out: "ğŸ’€ YOU ARE OUT!", lbl_was: "Your character was:", lbl_jury: "You can still vote as a Jury!",
                lbl_congrats: "ğŸ‰ CORRECT!", lbl_wait_end: "Waiting for others to finish...",
                lbl_all_chars: "PLAYERS & CHARACTERS", lbl_turn: "Whose Turn?",
                ph_q: "Ask a question (E.g. Am I a singer?)", btn_ask: "Send Question",
                ph_guess: "Make a guess (E.g. I am Elvis!)", btn_guess: "GUESS (Risk a Life)",
                lbl_q: "Current Question:", lbl_guess_alert: "âš ï¸ GUESS ALERT!",
                btn_yes: "YES", btn_no: "NO", btn_unsure: "UNSURE", lbl_hist: "Game History",
                msg_wait_vote: "Vote received. Waiting...", msg_friends_vote: "Friends are voting...",
                lbl_game_over: "ğŸ† GAME OVER!", btn_new_game: "ğŸ”„ New Game",
                lbl_room_players: "Players in Room",
                lbl_mm_title: "Matchmaking", lbl_mm_lang: "Language", lbl_mm_size: "Players Count",
                btn_mm_search: "ğŸ” Search Game",
                alert_name: "Please enter a name!", alert_code: "Please enter details!", alert_room404: "Room not found!",
                alert_min_pl: "Need at least 2 players!", alert_leave: "Are you sure you want to leave?",
                alert_reset: "Restart game for everyone?", alert_guess_confirm: "If wrong, you lose a life! Are you sure?",
                txt_starting: "Starting...", txt_submit_wait: "Waiting...", txt_searching: "Searching for rooms...",
                hist_yes: "YES", hist_no: "NO", hist_unsure: "?",
                txt_online: "Online Searching: "
            },
            tr: {
                flag: "ğŸ‡¹ğŸ‡·", langName: "TÃ¼rkÃ§e",
                btn_menu_play: "ArkadaÅŸlarla Oyna", btn_menu_play_sub: "Ã–zel Oda Kur veya KatÄ±l",
                btn_menu_find: "Oyun Ara", btn_menu_find_sub: "Rastgele EÅŸleÅŸme",
                btn_menu_rules: "NasÄ±l OynanÄ±r?", btn_menu_lang: "Dil", btn_menu_lang_sub: "Dili DeÄŸiÅŸtir",
                lbl_rules_title: "NasÄ±l OynanÄ±r?",
                lbl_enter_details: "GiriÅŸ Yap", btn_back: "â€¹ Geri",
                lbl_rules_text: "1. <b>Karakter Atama:</b> Oyun baÅŸladÄ±ÄŸÄ±nda ekranda sana, karakter belirlemen gereken arkadaÅŸÄ±nÄ±n ismi verilecek. O kiÅŸi iÃ§in zorlu ve eÄŸlenceli bir <b>Ã¼nlÃ¼ karakter</b> (ÅarkÄ±cÄ±, Sporcu, Film Karakteri vb.) yaz ve gÃ¶nder.<br><br>2. <b>Soru Sorma:</b> SÄ±ra sana geldiÄŸinde kim olduÄŸunu bulmak iÃ§in gruba sorular sor (Ã–rn: 'GerÃ§ek biri miyim?', 'ÅarkÄ±cÄ± mÄ±yÄ±m?', 'Erkek miyim?'). ArkadaÅŸlarÄ±n bu soruna <b>Evet</b>, <b>HayÄ±r</b> veya <b>Emin DeÄŸilim</b> oyu vererek cevaplayacaklar.<br><br>3. <b>Oylama Sonucu:</b> OyuncularÄ±n verdiÄŸi oylarÄ±n Ã§oÄŸunluÄŸu ne derse, sistem cevabÄ± o ÅŸekilde kabul eder.<br><br>4. <b>Tahmin & Canlar:</b> Kim olduÄŸunu anladÄ±ysan <b>'Tahmin Et'</b> butonunu kullan. Ama dikkatli ol! YanlÄ±ÅŸ tahmin yaparsan <b>1 Can (â¤ï¸)</b> kaybedersin.<br><br>5. <b>JÃ¼ri Modu:</b> EÄŸer 3 canÄ±n biterse elenirsin. Ama Ã¼zÃ¼lme! Oyun bitmez, 'JÃ¼ri' olarak diÄŸerlerinin sorularÄ±nÄ± oylamaya devam edersin.<br><br>6. <b>Kazanma:</b> Karakterini doÄŸru bilen oyuncular, bilme sÄ±ralarÄ±na gÃ¶re liderlik tablosuna yerleÅŸir!",

                ph_name: "AdÄ±nÄ± gir", btn_create: "Yeni Oda Kur", ph_room: "Oda Kodu", btn_join: "KatÄ±l",
                lbl_room: "Oda Kodu:", lbl_wait: "Oyuncular bekleniyor...", lbl_admin: "YÃ¶neticisin", btn_start: "Oyunu BaÅŸlat",
                lbl_wait_admin: "YÃ¶netici bekleniyor...", lbl_assign_t: "Karakter Belirle", lbl_assign_d: "Åu kiÅŸi iÃ§in bir karakter yaz:",
                ph_char: "Ã–rn: Tarkan, Batman...", btn_submit: "GÃ¶nder", msg_wait_others: "DiÄŸerleri bekleniyor...",
                btn_leave: "ğŸšª AyrÄ±l", btn_reset: "ğŸ”„ SÄ±fÄ±rla",
                lbl_out: "ğŸ’€ ELENDÄ°N!", lbl_was: "Karakterin ÅŸuydu:", lbl_jury: "JÃ¼ri olarak oy verebilirsin!",
                lbl_congrats: "ğŸ‰ DOÄRU BÄ°LDÄ°N!", lbl_wait_end: "DiÄŸerlerinin bitirmesi bekleniyor...",
                lbl_all_chars: "OYUNCULAR VE KARAKTERLER", lbl_turn: "SÄ±ra Kimde?",
                ph_q: "Bir soru sor (Ã–rn: ÅarkÄ±cÄ± mÄ±yÄ±m?)", btn_ask: "Soruyu GÃ¶nder",
                ph_guess: "Tahmin yap (Ã–rn: Ben TarkanÄ±m!)", btn_guess: "TAHMÄ°N ET (Can Gider)",
                lbl_q: "Sorulan Soru:", lbl_guess_alert: "âš ï¸ TAHMÄ°N GELDÄ°!",
                btn_yes: "EVET", btn_no: "HAYIR", btn_unsure: "EMÄ°N DEÄÄ°LÄ°M", lbl_hist: "Oyun GeÃ§miÅŸi",
                msg_wait_vote: "Oyun alÄ±ndÄ±. Bekleniyor...", msg_friends_vote: "ArkadaÅŸlarÄ±n oyluyor...",
                lbl_game_over: "ğŸ† OYUN BÄ°TTÄ°!", btn_new_game: "ğŸ”„ Yeni Oyun",
                lbl_room_players: "Odada Olanlar",
                lbl_mm_title: "Oyun Bul", lbl_mm_lang: "Dil Tercihi", lbl_mm_size: "Oyuncu SayÄ±sÄ±",
                btn_mm_search: "ğŸ” Oyun Ara",
                alert_name: "LÃ¼tfen isim gir!", alert_code: "LÃ¼tfen bilgileri doldur!", alert_room404: "Oda bulunamadÄ±!",
                alert_min_pl: "En az 2 kiÅŸi gerekli!", alert_leave: "Odadan Ã§Ä±kmak istediÄŸine emin misin?",
                alert_reset: "Oyunu herkes iÃ§in sÄ±fÄ±rlamak istiyor musun?", alert_guess_confirm: "YanlÄ±ÅŸsa 1 canÄ±n gider! Emin misin?",
                txt_starting: "BaÅŸlatÄ±lÄ±yor...", txt_submit_wait: "Bekleniyor...", txt_searching: "Oda aranÄ±yor...",
                hist_yes: "EVET", hist_no: "HAYIR", hist_unsure: "?",
                txt_online: "Bu modda arayan: "
            },
            de: {
                flag: "ğŸ‡©ğŸ‡ª", langName: "Deutsch",
                btn_menu_play: "Mit Freunden", btn_menu_play_sub: "Privaten Raum erstellen",
                btn_menu_find: "Spiel Suchen", btn_menu_find_sub: "ZufÃ¤llige Spieler",
                btn_menu_rules: "Spielregeln", btn_menu_lang: "Sprache", btn_menu_lang_sub: "Sprache Ã¤ndern",
                lbl_rules_title: "Spielregeln",
                lbl_enter_details: "Details eingeben", btn_back: "â€¹ ZurÃ¼ck",
                lbl_rules_text: "1. <b>Charakter zuweisen:</b> Zu Beginn wird dir der Name eines Freundes angezeigt. Schreibe einen schwierigen und lustigen <b>berÃ¼hmten Charakter</b> (SÃ¤nger, Sportler, Filmfigur usw.) fÃ¼r ihn auf.<br><br>2. <b>Fragen stellen:</b> Wenn du dran bist, stelle der Gruppe Ja/Nein-Fragen (z. B. 'Bin ich real?', 'Bin ich ein SÃ¤nger?', 'Bin ich mÃ¤nnlich?'). Deine Freunde stimmen mit <b>Ja</b>, <b>Nein</b> oder <b>Unsicher</b> ab.<br><br>3. <b>Abstimmungsergebnis:</b> Die Mehrheit der Stimmen bestimmt die Antwort.<br><br>4. <b>Raten & Leben:</b> Wenn du weiÃŸt, wer du bist, benutze den <b>'Raten'</b>-Button. Vorsicht! Ein falscher Tipp kostet <b>1 Leben (â¤ï¸)</b>.<br><br>5. <b>Jury-Modus:</b> Wenn alle 3 Leben weg sind, bist du raus. Aber keine Sorge! Du bleibst als 'Jury' und stimmst weiter ab.<br><br>6. <b>Gewinnen:</b> Wer seinen Charakter errÃ¤t, landet auf der Bestenliste!",

                ph_name: "Namen eingeben", btn_create: "Raum erstellen", ph_room: "Raumcode", btn_join: "Beitreten",
                lbl_room: "Raumcode:", lbl_wait: "Warte auf Spieler...", lbl_admin: "Du bist Admin", btn_start: "Spiel starten",
                lbl_wait_admin: "Warte auf Admin...", lbl_assign_t: "Charakter wÃ¤hlen", lbl_assign_d: "WÃ¤hle einen Charakter fÃ¼r:",
                ph_char: "z.B. Einstein, Batman...", btn_submit: "Senden", msg_wait_others: "Warte auf andere...",
                btn_leave: "ğŸšª Verlassen", btn_reset: "ğŸ”„ Neustart",
                lbl_out: "ğŸ’€ DU BIST RAUS!", lbl_was: "Dein Charakter war:", lbl_jury: "Du kannst als Jury abstimmen!",
                lbl_congrats: "ğŸ‰ RICHTIG!", lbl_wait_end: "Warte auf die anderen...",
                lbl_all_chars: "SPIELER & CHARAKTERE", lbl_turn: "Wer ist dran?",
                ph_q: "Stelle eine Frage (z.B. Bin ich ein SÃ¤nger?)", btn_ask: "Frage senden",
                ph_guess: "Rate mal (z.B. Ich bin Einstein!)", btn_guess: "RATEN (Leben riskieren)",
                lbl_q: "Aktuelle Frage:", lbl_guess_alert: "âš ï¸ RATEVERSUCH!",
                btn_yes: "JA", btn_no: "NEIN", btn_unsure: "UNSICHER", lbl_hist: "Spielverlauf",
                msg_wait_vote: "Stimme empfangen. Warten...", msg_friends_vote: "Freunde stimmen ab...",
                lbl_game_over: "ğŸ† SPIEL VORBEI!", btn_new_game: "ğŸ”„ Neues Spiel",
                lbl_room_players: "Spieler im Raum",
                lbl_mm_title: "Spielsuche", lbl_mm_lang: "Sprache", lbl_mm_size: "Spielerzahl",
                btn_mm_search: "ğŸ” Suchen",
                alert_name: "Bitte Namen eingeben!", alert_code: "Bitte Details eingeben!", alert_room404: "Raum nicht gefunden!",
                alert_min_pl: "Mindestens 2 Spieler nÃ¶tig!", alert_leave: "MÃ¶chtest du den Raum wirklich verlassen?",
                alert_reset: "Spiel fÃ¼r alle neu starten?", alert_guess_confirm: "Bei Fehler verlierst du ein Leben! Sicher?",
                txt_starting: "Startet...", txt_submit_wait: "Warten...", txt_searching: "Suche...",
                hist_yes: "JA", hist_no: "NEIN", hist_unsure: "?",
                txt_online: "Online Suchen: "
            },
            es: {
                flag: "ğŸ‡ªğŸ‡¸", langName: "EspaÃ±ol",
                btn_menu_play: "Con Amigos", btn_menu_play_sub: "Sala Privada",
                btn_menu_find: "Buscar Partida", btn_menu_find_sub: "Jugadores Aleatorios",
                btn_menu_rules: "CÃ³mo Jugar", btn_menu_lang: "Idioma", btn_menu_lang_sub: "Cambiar Idioma",
                lbl_rules_title: "CÃ³mo Jugar",
                lbl_enter_details: "Ingresar Datos", btn_back: "â€¹ Volver",
                lbl_rules_text: "1. <b>Asignar Personaje:</b> Al inicio, verÃ¡s el nombre de un amigo. Escribe un <b>personaje famoso</b> difÃ­cil y divertido (Cantante, Deportista, Personaje de PelÃ­cula, etc.) para Ã©l.<br><br>2. <b>Hacer Preguntas:</b> En tu turno, haz preguntas de SÃ­/No al grupo (Ej. 'Â¿Soy real?', 'Â¿Soy cantante?', 'Â¿Soy hombre?'). Tus amigos votarÃ¡n <b>SÃ­</b>, <b>No</b> o <b>No sÃ©</b>.<br><br>3. <b>Resultado de VotaciÃ³n:</b> La mayorÃ­a de los votos determina la respuesta.<br><br>4. <b>Adivinar y Vidas:</b> Si sabes quiÃ©n eres, usa el botÃ³n <b>'Adivinar'</b>. Â¡Cuidado! Una suposiciÃ³n incorrecta cuesta <b>1 Vida (â¤ï¸)</b>.<br><br>5. <b>Modo Jurado:</b> Si pierdes tus 3 vidas, estÃ¡s eliminado. Â¡Pero no te preocupes! Sigues como 'Jurado' votando las preguntas de los demÃ¡s.<br><br>6. <b>Ganar:</b> Â¡Los jugadores que adivinen correctamente aparecerÃ¡n en la tabla de clasificaciÃ³n!",

                ph_name: "Introduce tu nombre", btn_create: "Crear Nueva Sala", ph_room: "CÃ³digo de Sala", btn_join: "Unirse",
                lbl_room: "CÃ³digo de Sala:", lbl_wait: "Esperando jugadores...", lbl_admin: "Eres el Administrador", btn_start: "Iniciar Juego",
                lbl_wait_admin: "Esperando al administrador...", lbl_assign_t: "Asignar Personaje", lbl_assign_d: "Asigna un personaje para:",
                ph_char: "Ej. Elvis, Batman...", btn_submit: "Enviar", msg_wait_others: "Esperando a otros...",
                btn_leave: "ğŸšª Salir", btn_reset: "ğŸ”„ Reiniciar",
                lbl_out: "ğŸ’€ Â¡ESTÃS ELIMINADO!", lbl_was: "Tu personaje era:", lbl_jury: "Â¡AÃºn puedes votar como Jurado!",
                lbl_congrats: "ğŸ‰ Â¡CORRECTO!", lbl_wait_end: "Esperando a que otros terminen...",
                lbl_all_chars: "JUGADORES Y PERSONAJES", lbl_turn: "Â¿Turno de quiÃ©n?",
                ph_q: "Haz una pregunta (Ej. Â¿Soy cantante?)", btn_ask: "Enviar Pregunta",
                ph_guess: "Adivina (Ej. Â¡Soy Elvis!)", btn_guess: "ADIVINAR (Arriesgas Vida)",
                lbl_q: "Pregunta Actual:", lbl_guess_alert: "âš ï¸ Â¡ALERTA DE SUPOSICIÃ“N!",
                btn_yes: "SÃ", btn_no: "NO", btn_unsure: "NO SÃ‰", lbl_hist: "Historial",
                msg_wait_vote: "Voto recibido. Esperando...", msg_friends_vote: "Los amigos estÃ¡n votando...",
                lbl_game_over: "ğŸ† Â¡JUEGO TERMINADO!", btn_new_game: "ğŸ”„ Nuevo Juego",
                lbl_room_players: "Jugadores en Sala",
                lbl_mm_title: "Buscar Partida", lbl_mm_lang: "Idioma", lbl_mm_size: "Jugadores",
                btn_mm_search: "ğŸ” Buscar",
                alert_name: "Â¡Por favor introduce un nombre!", alert_code: "Â¡Por favor introduce detalles!", alert_room404: "Â¡Sala no encontrada!",
                alert_min_pl: "Â¡Se necesitan al menos 2 jugadores!", alert_leave: "Â¿Seguro que quieres salir?",
                alert_reset: "Â¿Reiniciar el juego para todos?", alert_guess_confirm: "Â¡Si fallas pierdes una vida! Â¿Seguro?",
                txt_starting: "Iniciando...", txt_submit_wait: "Esperando...", txt_searching: "Buscando...",
                hist_yes: "SÃ", hist_no: "NO", hist_unsure: "?",
                txt_online: "Buscando en lÃ­nea: "
            }
        };

        // --- LANGUAGE MANAGEMENT ---
        let currentLang = localStorage.getItem('whoami_lang') || 'en';
        
        window.toggleLang = function() { document.getElementById("langDropdown").classList.toggle("show"); }
        window.onclick = function(event) {
            if (!event.target.matches('#lang-btn-display')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show');
                }
            }
        }
        window.setLanguage = function(lang) {
            currentLang = lang;
            localStorage.setItem('whoami_lang', lang);
            updateUITexts();
            // Also update MM counter if on MM screen
            if(document.getElementById('screen-matchmaking').classList.contains('active')){
                updateOnlineCount();
            }
        };

        // NAVIGATION FUNCTIONS
        let isPublicMode = false;

        window.goToLogin = function(isPublic) {
            isPublicMode = isPublic;
            changeScreen('screen-login');
            
            const privateDiv = document.getElementById('private-controls');
            const publicDiv = document.getElementById('public-controls');
            
            if (isPublic) {
                privateDiv.style.display = 'none';
                publicDiv.style.display = 'block';
            } else {
                privateDiv.style.display = 'block';
                publicDiv.style.display = 'none';
            }
        }

        window.goToMatchmakingSetup = function() {
            myName = document.getElementById('username').value.trim();
            if(!myName) return alert(translations[currentLang].alert_name);
            
            changeScreen('screen-matchmaking');
            updateOnlineCount(); 
        }

        window.showHowToPlay = function() { changeScreen('screen-howtoplay'); }
        window.showLanguages = function() { changeScreen('screen-languages'); }
        window.goBackToWelcome = function() { changeScreen('screen-welcome'); }

        function updateUITexts() {
            const t = translations[currentLang];
            const langBtn = document.getElementById('lang-btn-display');
            if(langBtn) langBtn.innerHTML = `${t.flag} ${t.langName} â–¾`;

            if(document.getElementById('username')) document.getElementById('username').placeholder = t.ph_name;
            if(document.getElementById('room-code-input')) document.getElementById('room-code-input').placeholder = t.ph_room;
            if(document.getElementById('character-input')) document.getElementById('character-input').placeholder = t.ph_char;
            if(document.getElementById('question-input')) document.getElementById('question-input').placeholder = t.ph_q;
            if(document.getElementById('guess-input')) document.getElementById('guess-input').placeholder = t.ph_guess;

            setText('btn-menu-play', t.btn_menu_play);
            setText('btn-menu-play-sub', t.btn_menu_play_sub);
            setText('btn-menu-find', t.btn_menu_find);
            setText('btn-menu-find-sub', t.btn_menu_find_sub);
            setText('btn-menu-rules', t.btn_menu_rules);
            setText('btn-menu-lang', t.btn_menu_lang);
            setText('btn-menu-lang-sub', t.btn_menu_lang_sub);
            setText('lbl-rules-title', t.lbl_rules_title);
            setText('lbl-rules-text', t.lbl_rules_text);
            
            const backs = document.querySelectorAll('.btn-back');
            backs.forEach(b => b.innerText = t.btn_back);
            setText('lbl-enter-details', t.lbl_enter_details);

            setText('btn-create', t.btn_create);
            setText('btn-join', t.btn_join);
            setText('lbl-room-code', t.lbl_room);
            setText('lbl-waiting-players', t.lbl_wait);
            setText('lbl-you-admin', t.lbl_admin);
            setText('btn-start', t.btn_start);
            setText('waiting-msg', t.lbl_wait_admin);
            setText('lbl-assign-title', t.lbl_assign_t);
            setText('lbl-assign-desc', t.lbl_assign_d);
            setText('btn-submit-char', t.btn_submit);
            setText('setup-status', t.msg_wait_others);
            setText('btn-leave', t.btn_leave);
            setText('reset-btn', t.btn_reset);
            setText('lbl-eliminated', t.lbl_out);
            setText('lbl-was', t.lbl_was);
            setText('lbl-char-was', t.lbl_was);
            setText('lbl-jury-mode', t.lbl_jury);
            setText('lbl-congrats', t.lbl_congrats);
            setText('lbl-wait-end', t.lbl_wait_end);
            setText('lbl-players-chars', t.lbl_all_chars);
            setText('lbl-whose-turn', t.lbl_turn);
            setText('btn-send-q', t.btn_ask);
            setText('btn-send-guess', t.btn_guess);
            setText('vote-title', t.lbl_q);
            setText('btn-yes', t.btn_yes);
            setText('btn-no', t.btn_no);
            setText('btn-unsure', t.btn_unsure);
            setText('lbl-history', t.lbl_hist);
            setText('lbl-game-over-title', t.lbl_game_over);
            setText('lbl-room-players', t.lbl_room_players);
            
            // MM Texts
            setText('lbl-mm-title', t.lbl_mm_title);
            setText('lbl-mm-lang', t.lbl_mm_lang);
            setText('lbl-mm-size', t.lbl_mm_size);
            setText('btn-mm-search', t.btn_mm_search);
            setText('mm-status', t.txt_searching);
        }

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el && text) el.innerHTML = text; 
        }

        window.setLanguage(currentLang);

        // --- GAME LOGIC ---
        let myRoomCode = "";
        let myPlayerId = localStorage.getItem('whoami_pid');
        if (!myPlayerId) {
            myPlayerId = "p_" + Date.now() + "_" + Math.floor(Math.random()*1000);
            localStorage.setItem('whoami_pid', myPlayerId);
        }

        let myName = "";
        let myTargetId = ""; 
        let playersData = []; 
        
        window.createRoom = createRoom;
        window.joinRoom = joinRoom;
        window.startSetup = startSetup;
        window.submitCharacter = submitCharacter;
        window.askQuestion = askQuestion;
        window.vote = vote;
        window.makeGuess = makeGuess;
        window.resetGame = resetGame;
        window.leaveRoom = leaveRoom;
        window.findPublicGame = findPublicGame;
        window.updateOnlineCount = updateOnlineCount;

        // MATCHMAKING COUNTER LOGIC
        let currentSearchPath = null;

        function updateOnlineCount() {
            const lang = document.getElementById('mm-lang').value;
            const size = document.getElementById('mm-size').value;
            const newPath = `searching/${lang}_${size}`;

            // Remove from old path if changed
            if (currentSearchPath && currentSearchPath !== newPath) {
                remove(ref(db, `${currentSearchPath}/${myPlayerId}`));
            }
            
            // Add to new path
            currentSearchPath = newPath;
            set(ref(db, `${newPath}/${myPlayerId}`), true);
            onDisconnect(ref(db, `${newPath}/${myPlayerId}`)).remove();

            // Listen for count
            onValue(ref(db, newPath), (snap) => {
                const count = snap.exists() ? Object.keys(snap.val()).length : 0;
                document.getElementById('mm-online-count').innerText = translations[currentLang].txt_online + count;
            });
        }

        function findPublicGame() {
            const lang = document.getElementById('mm-lang').value;
            const size = parseInt(document.getElementById('mm-size').value);
            
            document.getElementById('btn-mm-search').disabled = true;
            document.getElementById('mm-status').style.display = 'block';

            get(ref(db, 'rooms')).then(snap => {
                let foundRoom = null;
                
                if (snap.exists()) {
                    const rooms = snap.val();
                    for (const code in rooms) {
                        const r = rooms[code];
                        if (r.isPublic && r.lang === lang && r.targetSize === size && r.gameState === 'lobby') {
                            const playerCount = Object.keys(r.players || {}).length;
                            if (playerCount < size) {
                                foundRoom = code;
                                break;
                            }
                        }
                    }
                }

                if (foundRoom) {
                    myRoomCode = foundRoom;
                    update(ref(db, `rooms/${foundRoom}/players/${myPlayerId}`), {
                        name: myName, score: 0, lives: 3, finishedRank: 0, hasSubmitted: false
                    }).then(() => listenRoom());
                } else {
                    createRoom(true, lang, size);
                }
            });
        }

        function createRoom(isPublic = false, lang = 'en', targetSize = 4) {
            myName = document.getElementById('username').value.trim();
            if (!myName) return alert(translations[currentLang].alert_name);
            
            myRoomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
            
            const roomData = {
                gameState: 'lobby',
                admin: myPlayerId,
                turnIndex: 0,
                players: { [myPlayerId]: { name: myName, score: 0, lives: 3, finishedRank: 0, hasSubmitted: false } },
                isPublic: isPublic,
                lang: isPublic ? lang : null,
                targetSize: isPublic ? targetSize : null
            };

            set(ref(db, `rooms/${myRoomCode}`), roomData)
                .catch(e => alert("Error: " + e.message));
            
            listenRoom();
        }

        function joinRoom() {
            myName = document.getElementById('username').value.trim();
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (!myName || !code) return alert(translations[currentLang].alert_code);

            get(ref(db, `rooms/${code}`)).then(snap => {
                if (snap.exists()) {
                    myRoomCode = code;
                    update(ref(db, `rooms/${code}/players/${myPlayerId}`), {
                        name: myName, score: 0, lives: 3, finishedRank: 0, hasSubmitted: false
                    }).then(() => listenRoom());
                } else {
                    alert(translations[currentLang].alert_room404);
                }
            }).catch(e => alert("Error: " + e.message));
        }

        function startSetup() {
            if (!myRoomCode) return;
            if (playersData.length < 2) return alert(translations[currentLang].alert_min_pl);

            const btn = document.querySelector('#admin-panel button');
            if(btn) { btn.innerText = translations[currentLang].txt_starting; btn.disabled = true; }

            const playerIds = playersData.map(p => p.id);
            shuffleArray(playerIds);

            const updates = {};
            updates[`rooms/${myRoomCode}/gameState`] = 'setup';
            updates[`rooms/${myRoomCode}/playerOrder`] = playerIds; 

            update(ref(db), updates)
            .catch((error) => {
                alert("Error: " + error.message);
                if(btn) { btn.innerText = translations[currentLang].btn_start; btn.disabled = false; }
            });
        }

        function listenRoom() {
            changeScreen('screen-lobby');
            document.getElementById('lobby-code').innerText = myRoomCode;

            onValue(ref(db, `rooms/${myRoomCode}`), (snap) => {
                const data = snap.val();
                if (!data || !data.players || !data.players[myPlayerId]) return;

                playersData = Object.keys(data.players || {}).map(key => ({
                    id: key, ...data.players[key]
                }));

                if (data.playerOrder && Array.isArray(data.playerOrder)) {
                    playersData.sort((a, b) => {
                        return data.playerOrder.indexOf(a.id) - data.playerOrder.indexOf(b.id);
                    });
                } else {
                    playersData.sort((a,b) => a.id.localeCompare(b.id));
                }

                // --- SEARCH LOGIC FIX ---
                // Only remove from searching list if Game Started OR Private Room
                if (data.isPublic && data.gameState === 'lobby') {
                    // Do nothing (Keep user in searching node to count as waiter)
                } else {
                    // Remove from searching node
                    if (currentSearchPath) {
                        remove(ref(db, `${currentSearchPath}/${myPlayerId}`));
                        currentSearchPath = null;
                    }
                }
                // -----------------------

                const resetBtn = document.getElementById('reset-btn');
                if(resetBtn) resetBtn.style.display = (data.admin === myPlayerId) ? 'block' : 'none';

                updateUITexts();

                if (data.gameState === 'lobby') {
                    const ul = document.getElementById('player-list');
                    ul.innerHTML = "";
                    playersData.forEach(p => ul.innerHTML += `<li>${p.name}</li>`);
                    
                    if (data.isPublic) {
                        document.getElementById('admin-panel').style.display = 'none';
                        document.getElementById('waiting-msg').style.display = 'none';
                        document.getElementById('public-wait-msg').style.display = 'block';
                        document.getElementById('public-wait-msg').innerText = `Waiting for players... (${playersData.length}/${data.targetSize})`;

                        if (data.admin === myPlayerId && playersData.length >= data.targetSize) {
                            startSetup();
                        }
                    } else {
                        document.getElementById('public-wait-msg').style.display = 'none';
                        if (data.admin === myPlayerId) document.getElementById('admin-panel').style.display = 'block';
                        else document.getElementById('waiting-msg').style.display = 'block';
                    }
                }

                if (data.gameState === 'setup') {
                    changeScreen('screen-setup');
                    document.getElementById('character-input').value = ""; 
                    
                    const myIndex = playersData.findIndex(p => p.id === myPlayerId);
                    const me = playersData.find(p => p.id === myPlayerId);

                    if (myIndex !== -1) {
                        const targetPlayer = playersData[(myIndex + 1) % playersData.length];
                        myTargetId = targetPlayer.id;
                        document.getElementById('target-player-name').innerText = targetPlayer.name;
                    }

                    if (me && me.hasSubmitted) {
                        document.getElementById('btn-submit-char').disabled = true;
                        document.getElementById('btn-submit-char').innerText = translations[currentLang].txt_submit_wait;
                    } else {
                        document.getElementById('btn-submit-char').disabled = false;
                        document.getElementById('btn-submit-char').innerText = translations[currentLang].btn_submit;
                    }

                    const setupList = document.getElementById('setup-player-list');
                    setupList.innerHTML = "";
                    playersData.forEach(p => {
                        const statusIcon = p.hasSubmitted ? "âœ…" : "â³";
                        const doneClass = p.hasSubmitted ? "done" : "";
                        setupList.innerHTML += `<div class="setup-player-badge ${doneClass}">${p.name} ${statusIcon}</div>`;
                    });

                    if (playersData.every(p => p.hasSubmitted) && data.admin === myPlayerId) {
                        update(ref(db, `rooms/${myRoomCode}`), { gameState: 'game' });
                    }
                }

                if (data.gameState === 'game') {
                    changeScreen('screen-game');
                    renderGame(data);
                    renderHistoryBoard(data.history, playersData);
                }

                if (data.gameState === 'leaderboard') {
                    changeScreen('screen-leaderboard');
                    renderLeaderboard(playersData);
                }
            });
        }

        function renderGame(data) {
            if (!playersData.length) return;
            const t = translations[currentLang];
            
            const currentPlayer = playersData[data.turnIndex % playersData.length];
            document.getElementById('current-turn-name').innerText = currentPlayer.name;

            const me = playersData.find(p => p.id === myPlayerId);
            const lives = me.lives !== undefined ? me.lives : 3;
            document.getElementById('my-lives').innerText = "â¤ï¸".repeat(lives);

            const charListEl = document.getElementById('characters-list');
            charListEl.innerHTML = ""; 
            playersData.forEach(p => {
                const isMe = p.id === myPlayerId;
                const isFinished = p.finishedRank > 0;
                
                const charVal = (isMe && !isFinished) ? "???" : (p.assignedChar || "...");
                const hiddenClass = (isMe && !isFinished) ? "hidden" : ""; 
                const meClass = isMe ? "is-me" : "";     

                const cardDiv = document.createElement("div");
                cardDiv.className = `char-card ${meClass}`; 

                const nameDiv = document.createElement("div");
                nameDiv.className = "char-card-name";
                nameDiv.textContent = p.name; 

                const valDiv = document.createElement("div");
                valDiv.className = `char-card-val ${hiddenClass}`;
                valDiv.textContent = charVal; 

                if (p.finishedRank > 0) {
                    const badge = document.createElement("div");
                    badge.className = "status-badge status-won";
                    badge.innerText = "âœ“";
                    cardDiv.appendChild(badge);
                } else if (p.lives <= 0) {
                    const badge = document.createElement("div");
                    badge.className = "status-badge status-dead";
                    badge.innerText = "X";
                    cardDiv.appendChild(badge);
                }

                cardDiv.appendChild(nameDiv);
                cardDiv.appendChild(valDiv);
                charListEl.appendChild(cardDiv);
            });

            const amIDead = (lives <= 0);
            const amIWon = (me.finishedRank > 0);

            document.getElementById('eliminated-msg').style.display = 'none';
            document.getElementById('success-msg').style.display = 'none';
            document.getElementById('my-turn-area').style.display = 'none';
            document.getElementById('voting-area').style.display = 'none';
            document.getElementById('waiting-vote-msg').style.display = 'none';

            if (amIWon) {
                document.getElementById('success-msg').style.display = 'block';
                document.getElementById('reveal-char-win').innerText = me.assignedChar;
            } 
            else if (amIDead) {
                document.getElementById('eliminated-msg').style.display = 'block';
                document.getElementById('reveal-char').innerText = me.assignedChar;
            }

            const currentIsDone = (currentPlayer.lives <= 0) || (currentPlayer.finishedRank > 0);
            
            if (data.admin === myPlayerId && currentIsDone && !data.currentQuestion && data.gameState === 'game') {
                const activePlayers = playersData.filter(p => p.lives > 0 && p.finishedRank === 0);
                if (activePlayers.length === 0) {
                    update(ref(db, `rooms/${myRoomCode}`), { gameState: 'leaderboard' });
                } else {
                    setTimeout(() => {
                        update(ref(db, `rooms/${myRoomCode}`), { turnIndex: data.turnIndex + 1 });
                    }, 1000);
                }
                return;
            }

            const isMyTurn = (currentPlayer.id === myPlayerId);
            const activeQuestion = data.currentQuestion;
            const isGuessAction = data.isGuess === true;

            if (isMyTurn && !activeQuestion && !amIDead && !amIWon) {
                document.getElementById('my-turn-area').style.display = 'block';
            } 
            else if (!isMyTurn && activeQuestion) {
                const titleEl = document.getElementById('vote-title');
                titleEl.innerText = isGuessAction ? t.lbl_guess_alert : t.lbl_q;
                titleEl.style.color = isGuessAction ? "#8e44ad" : "#fff";

                const myVote = data.votes ? data.votes[myPlayerId] : null;
                
                if (!myVote) {
                    document.getElementById('voting-area').style.display = 'block';
                    document.getElementById('voting-question').innerText = activeQuestion;
                } else {
                    document.getElementById('waiting-vote-msg').style.display = 'block';
                    document.getElementById('waiting-vote-msg').innerText = t.msg_wait_vote;
                }
            } 
            else if (isMyTurn && activeQuestion) {
                document.getElementById('waiting-vote-msg').style.display = 'block';
                document.getElementById('waiting-vote-msg').innerText = t.msg_friends_vote;
            }

            if (activeQuestion && data.votes && data.admin === myPlayerId && !data.processing) {
                const totalPlayers = playersData.length;
                const voteCount = Object.keys(data.votes).length;
                
                if (voteCount >= totalPlayers - 1) {
                    update(ref(db, `rooms/${myRoomCode}`), { processing: true });

                    const yes = Object.values(data.votes).filter(v => v === 'yes').length;
                    const no = Object.values(data.votes).filter(v => v === 'no').length;
                    let result = yes > no ? 'yes' : (no > yes ? 'no' : 'unsure');

                    if (isGuessAction) {
                        if (result === 'yes') {
                            const alreadyWon = playersData.filter(p => p.finishedRank > 0).length;
                            const newRank = alreadyWon + 1;
                            update(ref(db, `rooms/${myRoomCode}/players/${currentPlayer.id}`), { finishedRank: newRank });
                            push(ref(db, `rooms/${myRoomCode}/history`), { playerId: currentPlayer.id, question: "[GUESS] " + activeQuestion, result: 'yes', timestamp: Date.now() });
                            setTimeout(() => {
                                const actives = playersData.filter(p => p.id !== currentPlayer.id && p.lives > 0 && p.finishedRank === 0);
                                if(actives.length === 0) update(ref(db, `rooms/${myRoomCode}`), { gameState: 'leaderboard' });
                                else passTurn(data.turnIndex);
                            }, 2000);
                        } else {
                            const newLives = (currentPlayer.lives !== undefined ? currentPlayer.lives : 3) - 1;
                            update(ref(db, `rooms/${myRoomCode}/players/${currentPlayer.id}`), { lives: newLives });
                            push(ref(db, `rooms/${myRoomCode}/history`), { playerId: currentPlayer.id, question: "[GUESS] " + activeQuestion, result: 'no', timestamp: Date.now() });
                            setTimeout(() => {
                                const actives = playersData.filter(p => (p.id === currentPlayer.id ? newLives > 0 : true) && p.lives > 0 && p.finishedRank === 0);
                                if(actives.length === 0) update(ref(db, `rooms/${myRoomCode}`), { gameState: 'leaderboard' });
                                else passTurn(data.turnIndex);
                            }, 2000);
                        }
                    } else {
                        push(ref(db, `rooms/${myRoomCode}/history`), { playerId: currentPlayer.id, question: activeQuestion, result: result, timestamp: Date.now() });
                        setTimeout(() => passTurn(data.turnIndex), 2000);
                    }
                }
            }
        }

        function renderLeaderboard(players) {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = "";
            const sorted = [...players].sort((a, b) => {
                if (a.finishedRank > 0 && b.finishedRank > 0) return a.finishedRank - b.finishedRank;
                if (a.finishedRank > 0) return -1;
                if (b.finishedRank > 0) return 1;
                return 0;
            });
            sorted.forEach(p => {
                let rankDisplay = "", medalClass = "";
                if (p.finishedRank === 1) { rankDisplay = "1."; medalClass = "lb-medal-1"; }
                else if (p.finishedRank === 2) { rankDisplay = "2."; medalClass = "lb-medal-2"; }
                else if (p.finishedRank === 3) { rankDisplay = "3."; medalClass = "lb-medal-3"; }
                else if (p.finishedRank > 3) { rankDisplay = p.finishedRank + "."; }
                else { rankDisplay = "-"; }
                list.innerHTML += `<div class="lb-row"><div class="lb-rank ${medalClass}">${rankDisplay}</div><div class="lb-info"><div class="lb-name">${p.name}</div><div class="lb-char">${p.assignedChar}</div></div></div>`;
            });
        }

        function passTurn(currentIndex) {
            const updates = {};
            updates[`rooms/${myRoomCode}/turnIndex`] = currentIndex + 1;
            updates[`rooms/${myRoomCode}/currentQuestion`] = null;
            updates[`rooms/${myRoomCode}/votes`] = null;
            updates[`rooms/${myRoomCode}/isGuess`] = null;
            updates[`rooms/${myRoomCode}/processing`] = null;
            update(ref(db), updates);
        }

        function renderHistoryBoard(historyData, players) {
            const board = document.getElementById('history-board');
            board.innerHTML = ""; 
            const historyList = historyData ? Object.values(historyData) : [];
            const t = translations[currentLang];
            players.forEach(player => {
                const col = document.createElement('div');
                col.className = 'player-column';
                const playerQuestions = historyList.filter(h => h.playerId === player.id);
                const yesQs = playerQuestions.filter(h => h.result === 'yes');
                const noQs = playerQuestions.filter(h => h.result === 'no');
                const unsureQs = playerQuestions.filter(h => h.result === 'unsure');
                let htmlContent = `<div class="player-col-header">${player.name} (${player.lives}â¤ï¸)</div>`;
                if(yesQs.length > 0) {
                    htmlContent += `<div class="result-group group-yes"><div class="res-title" style="color:#2ecc71">${t.hist_yes}</div>`;
                    yesQs.forEach(q => htmlContent += `<div class="q-item ${q.question.includes('[') ? 'guess-item' : ''}">${q.question}</div>`);
                    htmlContent += `</div>`;
                }
                if(noQs.length > 0) {
                    htmlContent += `<div class="result-group group-no"><div class="res-title" style="color:#e74c3c">${t.hist_no}</div>`;
                    noQs.forEach(q => htmlContent += `<div class="q-item ${q.question.includes('[') ? 'guess-item' : ''}">${q.question}</div>`);
                    htmlContent += `</div>`;
                }
                if(unsureQs.length > 0) {
                    htmlContent += `<div class="result-group group-unsure"><div class="res-title" style="color:#f39c12">${t.hist_unsure}</div>`;
                    unsureQs.forEach(q => htmlContent += `<div class="q-item">${q.question}</div>`);
                    htmlContent += `</div>`;
                }
                col.innerHTML = htmlContent;
                board.appendChild(col);
            });
        }

        function vote(val) {
            if (!myRoomCode || !myPlayerId) return;
            set(ref(db, `rooms/${myRoomCode}/votes/${myPlayerId}`), val);
        }

        function askQuestion() {
            const q = document.getElementById('question-input').value.trim();
            if (!q) return;
            update(ref(db, `rooms/${myRoomCode}`), { currentQuestion: q, isGuess: false, votes: null, processing: null });
            document.getElementById('question-input').value = "";
        }

        function makeGuess() {
            const guess = document.getElementById('guess-input').value.trim();
            if (!guess) return;
            update(ref(db, `rooms/${myRoomCode}`), { currentQuestion: guess, isGuess: true, votes: null, processing: null });
            document.getElementById('guess-input').value = "";
        }

        function submitCharacter() {
            const charName = document.getElementById('character-input').value.trim();
            if (!charName) return;
            
            const updates = {};
            updates[`rooms/${myRoomCode}/players/${myTargetId}/assignedChar`] = charName;
            updates[`rooms/${myRoomCode}/players/${myPlayerId}/hasSubmitted`] = true; 

            update(ref(db), updates);
            document.getElementById('btn-submit-char').disabled = true;
            document.getElementById('btn-submit-char').innerText = translations[currentLang].txt_submit_wait;
            
            document.getElementById('character-input').value = "";
        }

        function changeScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            const header = document.getElementById('main-header');
            if (screenId === 'screen-welcome' || screenId === 'screen-howtoplay' || screenId === 'screen-languages' || screenId === 'screen-login' || screenId === 'screen-matchmaking') {
                header.style.display = 'none';
            } else {
                header.style.display = 'flex';
            }
        }

        function leaveRoom() {
            if (!myRoomCode || !myPlayerId) return location.reload();
            if (confirm(translations[currentLang].alert_leave)) {
                // Ensure removed from searching list if leaving
                if (currentSearchPath) {
                    remove(ref(db, `${currentSearchPath}/${myPlayerId}`));
                }
                remove(ref(db, `rooms/${myRoomCode}/players/${myPlayerId}`))
                .then(() => location.reload());
            }
        }

        function resetGame() {
            if (confirm(translations[currentLang].alert_reset)) {
                const playerIds = playersData.map(p => p.id);
                shuffleArray(playerIds);
                const updates = {};
                updates[`rooms/${myRoomCode}/gameState`] = 'setup';
                updates[`rooms/${myRoomCode}/turnIndex`] = 0;
                updates[`rooms/${myRoomCode}/history`] = null;
                updates[`rooms/${myRoomCode}/currentQuestion`] = null;
                updates[`rooms/${myRoomCode}/votes`] = null;
                updates[`rooms/${myRoomCode}/winner`] = null;
                updates[`rooms/${myRoomCode}/playerOrder`] = playerIds; 
                playersData.forEach(p => {
                    updates[`rooms/${myRoomCode}/players/${p.id}/lives`] = 3;
                    updates[`rooms/${myRoomCode}/players/${p.id}/finishedRank`] = 0;
                    updates[`rooms/${myRoomCode}/players/${p.id}/assignedChar`] = null;
                    updates[`rooms/${myRoomCode}/players/${p.id}/hasSubmitted`] = false; 
                });
                update(ref(db), updates);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
</body>
</html>